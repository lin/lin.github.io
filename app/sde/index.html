<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometric Brownian Motion SDE Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- START: KaTeX (LaTeX) Support for beautiful math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-wn8B096e2W5E8G/V8Bw+r0R8YlK2pQ42vP4I015e1Jt6fO/kR2c6R0o8P51i2/1" crossorigin="anonymous">
    <!-- Added 'defer' and removed inline 'onload' for safer execution after DOM is ready -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-S3Y26zTjQz1n/o8+B024jVpA3I+k5u6pSgTqD3fGjGz/hD/e3dI1z6u8/J5fO" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-qr0g7b6pC5/mC/fS6eW0xYjD0eXqN3pC5t1Q8fQ" crossorigin="anonymous"></script>
    <!-- END: KaTeX (LaTeX) Support -->

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1f2937',
                        'secondary-dark': '#374151',
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styling for Chart.js tooltips */
        .chartjs-tooltip {
            background: #1f2937;
            border: 1px solid #4b5563;
            padding: 10px;
            border-radius: 8px;
            color: #f3f4f6;
            pointer-events: none;
            opacity: 1;
            transition: all 0.1s ease;
        }
        /* Style for the canvas container to ensure responsiveness */
        #chart-container {
            position: relative;
            height: 60vh; /* Responsive height */
            width: 100%;
        }
    </style>
</head>
<body class="bg-primary-dark text-gray-100 font-sans min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-accent-blue mb-2">
                Stochastic Differential Equation Simulator
            </h1>
            <p class="text-gray-400">
                Geometric Brownian Motion: $dS_t = \mu S_t dt + \sigma S_t dW_t$
            </p>
        </header>

        <!-- Input Panel -->
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Simulation Parameters</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- Initial Price (S0) -->
                <div>
                    <label for="initialPrice" class="block text-sm font-medium text-gray-300 mb-1">Initial Price ($S_0$)</label>
                    <input type="number" id="initialPrice" value="100" min="1" step="0.01"
                           class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>
                
                <!-- Drift (mu) -->
                <div>
                    <label for="drift" class="block text-sm font-medium text-gray-300 mb-1">Drift ($\mu$) (e.g. 0.05)</label>
                    <input type="number" id="drift" value="0.05" step="0.01"
                           class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>
                
                <!-- Volatility (sigma) -->
                <div>
                    <label for="volatility" class="block text-sm font-medium text-gray-300 mb-1">Volatility ($\sigma$) (e.g. 0.20)</label>
                    <input type="number" id="volatility" value="0.20" step="0.01" min="0"
                           class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>
                
                <!-- Number of Paths -->
                <div>
                    <label for="numPaths" class="block text-sm font-medium text-gray-300 mb-1">Number of Paths</label>
                    <input type="number" id="numPaths" value="10" min="1" max="50" step="1"
                           class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>
                
                <!-- Time Steps (N) -->
                <div class="lg:col-span-2">
                    <label for="numSteps" class="block text-sm font-medium text-gray-300 mb-1">Time Steps (N) (e.g. 252 for 1 year of trading days)</label>
                    <input type="number" id="numSteps" value="252" min="10" max="1000" step="1"
                           class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>

                <!-- Total Time (T) -->
                <div class="lg:col-span-2">
                    <label for="totalTime" class="block text-sm font-medium text-gray-300 mb-1">Total Time (T) (e.g. 1 year)</label>
                    <input type="number" id="totalTime" value="1" min="0.1" step="0.1"
                           class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>
            </div>

            <button onclick="runSimulation()" id="simulate-btn"
                    class="mt-6 w-full py-3 px-4 bg-accent-green hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-500/50">
                Run Simulation
            </button>
            <div id="messageBox" class="mt-4 hidden p-3 rounded-lg text-center bg-red-800 text-white"></div>
        </div>

        <!-- Simulation Results Chart -->
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Simulated Stock Price Paths</h2>
            <div id="chart-container">
                <canvas id="sdeChart"></canvas>
            </div>
        </div>

        <!-- SDE Explanation -->
        <div class="mt-8 p-6 bg-secondary-dark rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 text-accent-blue">About the Model</h2>
            <p class="text-gray-300">
                The Geometric Brownian Motion (GBM) model is a classic application of SDEs in finance. It assumes that the stock price ($S_t$) evolves according to a drift ($\mu$) and a random shock ($\sigma dW_t$).
            </p>
            <p class="text-gray-300 mt-4">
                The simulation uses the **Euler-Maruyama method** to approximate the continuous SDE. This involves breaking the time $T$ into small, discrete steps ($\Delta t$) and updating the price at each step using the following formula:
            </p>
            <div class="mt-3 mb-4 text-center text-lg font-mono p-3 bg-gray-700 rounded-lg overflow-x-auto">
                $S_{\text{new}} = S_{\text{current}} + \underbrace{(\mu S_t \Delta t)}_{\text{Deterministic Drift}} + \underbrace{(\sigma S_t \Delta W)}_{\text{Stochastic Shock}}$
            </div>
            <ul class="list-disc list-inside text-gray-400 space-y-2">
                <li><strong class="text-gray-200">$S_{\text{new}}$:</strong> The stock price at the next time step, $S_{t+\Delta t}$. In the code, this is the updated `St` value.</li>
                <li><strong class="text-gray-200">$S_{\text{current}}$:</strong> The current stock price, $S_t$.</li>
                <li><strong class="text-gray-200">$(\mu S_t \Delta t)$:</strong> The **Deterministic Drift**. This is the non-random expected return on the asset over the small time period $\Delta t$. It represents the asset's underlying rate of growth based on the parameter $\mu$.</li>
                <li><strong class="text-gray-200">$(\sigma S_t \Delta W)$:</strong> The **Stochastic Shock**. This term captures the randomness. It scales the **volatility** ($\sigma$) by the current price ($S_t$) and multiplies it by the random Wiener increment ($\Delta W$). This part causes the price paths to diverge.</li>
            </ul>
            
            <h3 class="text-lg font-semibold mt-6 mb-2 text-gray-200">The Role of $\Delta t$ and $\Delta W$</h3>
            <p class="text-gray-300">
                In the code, the **time step $\Delta t$** (`dt`) is simply the total time ($T$) divided by the number of steps ($N$). The crucial element is the **Wiener increment $\Delta W$** (`dW`).
            </p>
            <div class="mt-3 mb-4 text-center text-lg font-mono p-3 bg-gray-700 rounded-lg overflow-x-auto">
                $\Delta W \approx \sqrt{\Delta t} \cdot Z \quad \text{where } Z \sim N(0, 1)$
            </div>
            <ul class="list-disc list-inside text-gray-400 space-y-2">
                <li><strong class="text-gray-200">Time Step ($\Delta t$):</strong> Calculated as $\Delta t = T / N$. It represents a fixed, small slice of time (e.g., $1/252$ of a year). In the code, this is `dt`.</li>
                <li><strong class="text-gray-200">Random Variable ($Z$):</strong> The `randn()` function generates a random number $Z$ from a standard normal distribution, $N(0, 1)$ (zero mean, unit variance).</li>
                <li><strong class="text-gray-200">Wiener Increment ($\Delta W$):</strong> This is the random change in the Wiener process over the time $\Delta t$. It is normally distributed, $N(0, \Delta t)$. The formula $\sqrt{\Delta t} \cdot Z$ correctly gives it this variance.
                    <br>
                    **Why the square root?** This is the fundamental property of **Brownian Motion**: the **variance** of the change is proportional to the **time interval** ($\text{Var}(\Delta W) = \Delta t$), while the standard deviation (which we multiply by the $N(0,1)$ random variable $Z$) must be the **square root of the time interval** ($\text{StdDev}(\Delta W) = \sqrt{\Delta t}$). This ensures that the accumulated randomness scales correctly over time.
                </li>
            </ul>
        </div>
    </div>

    <script>
        // Global variables for the chart instance
        let sdeChart;

        /**
         * Generates a single normally distributed random number (Z ~ N(0, 1)) using the Box-Muller transform.
         * @returns {number} A standard normally distributed random number.
         */
        function randn() {
            let u = 0, v = 0;
            while (u === 0) u = Math.random(); // Converting (0,1) to (0,1]
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        /**
         * Generates a random hex color for chart lines.
         * @returns {string} A hex color string.
         */
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            // Ensure the color is not too dark for a dark background
            const r = parseInt(color.substring(1, 3), 16);
            const g = parseInt(color.substring(3, 5), 16);
            const b = parseInt(color.substring(5, 7), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness < 100 ? getRandomColor() : color;
        }

        /**
         * Performs the Geometric Brownian Motion simulation using the Euler-Maruyama method.
         * @param {number} S0 - Initial price.
         * @param {number} mu - Drift coefficient.
         * @param {number} sigma - Volatility coefficient.
         * @param {number} T - Total time (in years).
         * @param {number} N - Number of time steps.
         * @param {number} numPaths - Number of paths to simulate.
         * @returns {Array<Array<number>>} A 2D array where each inner array is a simulated path.
         */
        function simulateGBM(S0, mu, sigma, T, N, numPaths) {
            const dt = T / N; // Time step size (Delta t)
            const sqrtDt = Math.sqrt(dt);
            const paths = [];

            for (let p = 0; p < numPaths; p++) {
                const path = [S0]; // Start with the initial price
                let St = S0;

                for (let i = 0; i < N; i++) {
                    // dW(t) is approximated by sqrt(dt) * Z, where Z ~ N(0, 1)
                    const Z = randn();
                    const dW = sqrtDt * Z; // Wiener Increment (Delta W)

                    // Calculate the new price using Euler-Maruyama
                    St = St + (mu * St * dt) + (sigma * St * dW);
                    path.push(St);
                }
                paths.push(path);
            }
            return paths;
        }

        /**
         * Initializes or updates the Chart.js visualization.
         * @param {Array<Array<number>>} simulationResults - The 2D array of simulated paths.
         * @param {number} N - Number of time steps.
         */
        function updateChart(simulationResults, N) {
            const ctx = document.getElementById('sdeChart').getContext('2d');
            
            // Create time labels (0, 1, 2, ..., N)
            const labels = Array.from({ length: N + 1 }, (_, i) => i);

            const datasets = simulationResults.map((path, index) => {
                const color = getRandomColor();
                return {
                    label: `Path ${index + 1}`,
                    data: path,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    pointRadius: 0, // Hide points for a cleaner line chart
                    borderWidth: 1.5,
                };
            });

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'Monte Carlo Simulation of Asset Price',
                            color: '#f3f4f6',
                            font: { size: 18 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(55, 65, 81, 0.9)', // secondary-dark
                            titleColor: '#f3f4f6',
                            bodyColor: '#d1d5db',
                            borderColor: '#4b5563',
                            borderWidth: 1,
                            cornerRadius: 8,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Step',
                                color: '#a1a1a1'
                            },
                            ticks: { color: '#a1a1a1' },
                            grid: { color: 'rgba(75, 85, 99, 0.5)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price ($)',
                                color: '#a1a1a1'
                            },
                            ticks: { color: '#a1a1a1' },
                            grid: { color: 'rgba(75, 85, 99, 0.5)' }
                        }
                    },
                    animation: {
                        duration: 0 // Disable animation for immediate results
                    }
                },
            };

            if (sdeChart) {
                // If chart exists, destroy and create a new one
                sdeChart.destroy();
            }
            sdeChart = new Chart(ctx, chartConfig);
        }

        /**
         * Main function to read inputs, run simulation, and update the chart.
         */
        function runSimulation() {
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('hidden');
            
            const S0 = parseFloat(document.getElementById('initialPrice').value);
            const mu = parseFloat(document.getElementById('drift').value);
            const sigma = parseFloat(document.getElementById('volatility').value);
            const numPaths = parseInt(document.getElementById('numPaths').value);
            const N = parseInt(document.getElementById('numSteps').value);
            const T = parseFloat(document.getElementById('totalTime').value);
            
            // Basic validation
            if (isNaN(S0) || isNaN(mu) || isNaN(sigma) || isNaN(numPaths) || isNaN(N) || isNaN(T) || S0 <= 0 || sigma < 0 || numPaths < 1 || N < 10 || T <= 0) {
                messageBox.textContent = "Please enter valid, positive numbers for all parameters. Volatility must be non-negative.";
                messageBox.classList.remove('hidden');
                return;
            }

            // Run the Monte Carlo simulation
            const results = simulateGBM(S0, mu, sigma, T, N, numPaths);

            // Update the chart visualization
            updateChart(results, N);
        }

        /**
         * Renders all LaTeX math using KaTeX auto-render.
         */
        function renderMath() {
            // Check if KaTeX auto-render is available globally
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    // Configure delimiters for inline ($...$) and display ($$...$$) math
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ]
                });
            } else {
                console.warn("KaTeX auto-render script not loaded or body not ready.");
            }
        }
        
        // Run simulation and render math on load for a clean initial view
        // Using an arrow function ensures both initialization steps are executed.
        window.onload = () => {
            renderMath();
            runSimulation();
        };

    </script>
</body>
</html>
